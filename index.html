<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üçΩÔ∏è DashControl Restaurante Premium</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { margin:0; font-family:'Poppins',sans-serif; background:#0d0d0d; color:white; }
    header { background:linear-gradient(90deg,#8e44ad,#b8860b); padding:15px; font-size:22px; font-weight:700; text-align:center; }
    nav { display:flex; justify-content:center; flex-wrap:wrap; background:#1e1e1e; }
    nav button { background:#8e44ad; border:none; margin:5px; padding:10px 15px; border-radius:8px; color:white; font-weight:bold; cursor:pointer; }
    nav button:hover { background:#b8860b; }
    section { display:none; padding:20px; max-width:1000px; margin:auto; }
    h2 { color:#d4af37; margin:15px 0; }
    input, select { padding:10px; border:none; border-radius:6px; width:100%; margin:5px 0; background:#2c2c2c; color:white; }
    .btn { background:#8e44ad; padding:10px; margin:5px; border-radius:6px; cursor:pointer; border:none; color:white; font-weight:bold; }
    .btn:hover { background:#b8860b; }
    .list { background:#1a1a1a; border-radius:8px; padding:10px; margin-top:10px; }
    .list div { padding:6px 0; border-bottom:1px solid #333; }
    .list-item { display: flex; align-items: center; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #333; }
    .list-item:last-child { border-bottom: none; }
    .list-item-buttons { display: flex; gap: 5px; }
    .chart-card { background:#1a1a1a; border-radius:12px; padding:15px; margin:20px auto; box-shadow:0 4px 20px rgba(0,0,0,0.6); max-width:1200px; }
    .chart { width:100%; height:400px; }
    /* Estilos para os bot√µes de produto menores */
    .produtos-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 20px; }
    .prod-btn { font-size:16px; padding:10px; margin:0; border:none; border-radius:10px; background:#2c2c2c; color:white; cursor:pointer; width:100px; height:90px; display:flex; flex-direction:column; align-items:center; justify-content:center; }
    .prod-btn:hover { background:#8e44ad; transform:scale(1.05); }
    .prod-btn .icon { font-size: 2em; }
    .prod-btn .details { font-size: 0.8em; line-height: 1.2; text-align: center; }
    
    .pay-btn { font-size:16px; padding:10px; margin:5px; border:none; border-radius:8px; cursor:pointer; width:100px; color:white; }
    .pay-pix { background:#27ae60; } .pay-debito { background:#2980b9; } .pay-credito { background:#8e44ad; } .pay-dinheiro { background:#f39c12; }
    .pay-btn:hover { opacity:0.9; transform:scale(1.05); }
    .kpi { background:#1a1a1a; display:inline-block; padding:15px; border-radius:10px; margin:10px; min-width:150px; font-size:14px; }
    .low-stock { color:#e74c3c; font-weight:bold; }
    .edit-btn, .remove-btn {
        background: #2c3e50;
        color: #fff;
        border: none;
        padding: 5px 8px;
        border-radius: 5px;
        font-size: 12px;
        cursor: pointer;
        margin-left: 10px;
    }
    .remove-btn { background: #c0392b; }
    .edit-btn:hover { background: #34495e; }
    .remove-btn:hover { background: #e74c3c; }

    .mesas-container { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; }
    .mesa-card { background: #1a1a1a; border-radius: 12px; padding: 20px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.4); width: 150px; cursor: pointer; transition: transform 0.2s; }
    .mesa-card:hover { transform: translateY(-5px); }
    .mesa-card h4 { color: #d4af37; margin: 0 0 10px 0; font-size: 1.2rem; }
    .mesa-card p { margin: 5px 0; font-size: 0.9rem; }
    .mesa-card .pay-btn { display: block; width: 100%; margin: 5px 0; font-size: 16px; }

    .modal {
        display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
        background-color: rgba(0,0,0,0.8); justify-content: center; align-items: center;
    }
    .modal-content {
        background-color: #1a1a1a; padding: 30px; border-radius: 12px;
        width: 80%; max-width: 400px; text-align: center; box-shadow: 0 5px 25px rgba(0,0,0,0.6);
    }
    .modal-content h3 { color: #d4af37; margin-top: 0; }
    .modal-buttons { margin-top: 20px; }
    .modal-buttons button { margin: 0 5px; padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; }
    .modal-ok { background-color: #8e44ad; color: white; }
    .modal-cancel { background-color: #c0392b; color: white; }

    .mesa-modal-content {
        background-color: #1a1a1a; padding: 20px; border-radius: 12px;
        width: 90%; max-width: 500px; box-shadow: 0 5px 25px rgba(0,0,0,0.6);
        text-align: left;
    }
    .mesa-modal-content h3 { color: #d4af37; text-align: center; }
    .mesa-modal-content .list { margin: 10px 0; }
    .mesa-modal-content .total-info { text-align: right; margin-top: 15px; font-size: 1.2rem; font-weight: bold; }
    .mesa-modal-content .checkbox-container { display: flex; align-items: center; justify-content: flex-end; gap: 10px; margin: 10px 0; }
    .mesa-modal-content .pay-buttons-container { display: flex; justify-content: center; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
    .mesa-modal-content .pay-btn { flex-grow: 1; max-width: 120px; }

    .back-btn {
        background: #1a1a1a;
        color: #fff;
        border: none;
        padding: 10px 15px;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        margin-bottom: 20px;
    }
    .back-btn:hover { background: #333; }

    .welcome-card {
        background: #1a1a1a;
        border-radius: 12px;
        padding: 40px;
        text-align: center;
        box-shadow: 0 4px 20px rgba(0,0,0,0.6);
        max-width: 400px;
        margin: 50px auto;
    }

    .welcome-card img {
        width: 120px;
        height: 120px;
        margin-bottom: 20px;
        border-radius: 50%;
        object-fit: cover;
    }

    @media (max-width: 600px) {
        nav { flex-direction: column; align-items: center; }
        nav button { width: 90%; }
        .produtos-container { flex-direction: column; align-items: center; }
        .prod-btn { width: 90%; height: auto; flex-direction: row; justify-content: flex-start; }
        .prod-btn .icon { margin-right: 15px; }
        .prod-btn .details { text-align: left; }
        .mesas-container { flex-direction: column; }
        .mesa-card, .mesa-modal-content, .modal-content { width: 90%; max-width: none; }
        .welcome-card { width: 90%; }
    }
  </style>
</head>
<body>
<header>üçΩÔ∏è DashControl Restaurante Premium</header>
<nav>
  <button onclick="showTab('inicio')">üè† In√≠cio</button>
  <button onclick="showTab('garcom')">üßë Gar√ßom</button>
  <button onclick="showTab('caixa')">üíµ Caixa</button>
  <button onclick="showTab('admin')">‚öôÔ∏è Admin</button>
  <button onclick="showTab('dashboard')">üìä Dashboard</button>
</nav>

<!-- Modal Gen√©rico -->
<div id="customModal" class="modal">
    <div class="modal-content">
        <h3 id="modalMessage"></h3>
        <div id="modalButtons" class="modal-buttons"></div>
        <div id="modalContent"></div>
    </div>
</div>

<!-- Modal de Detalhes da Mesa -->
<div id="mesaDetailsModal" class="modal">
    <div class="mesa-modal-content">
        <h3 id="mesaDetailsTitle"></h3>
        <div id="mesaDetailsList" class="list"></div>
        <div class="checkbox-container">
            <input type="checkbox" id="taxCheckbox">
            <label for="taxCheckbox">Incluir 10%</label>
        </div>
        <div class="total-info">
            Total: <span id="finalTotal">R$0.00</span>
        </div>
        <div id="mesaDetailsPayButtons" class="pay-buttons-container"></div>
    </div>
</div>

<!-- Modal de Confirma√ß√£o de Pagamento -->
<div id="confirmPaymentModal" class="modal">
    <div class="modal-content">
        <h3 id="confirmPaymentTitle"></h3>
        <p id="confirmPaymentInfo"></p>
        <div class="modal-buttons">
            <button class="modal-ok" id="confirmPaymentBtn">Pagamento Confirmado</button>
            <button class="modal-cancel" onclick="document.getElementById('confirmPaymentModal').style.display='none';">Cancelar</button>
        </div>
    </div>
</div>

<!-- üè† In√≠cio -->
<section id="inicio">
  <div class="welcome-card">
    <img src="https://placehold.co/120x120/8e44ad/ffffff?text=Logo" alt="Logo do Restaurante">
    <h3>Bem-vindo ao DashControl!</h3>
    <p>O seu sistema de gerenciamento de restaurante.</p>
  </div>
</section>

<!-- üßë Gar√ßom -->
<section id="garcom">
  <h2>üßë √Årea do Gar√ßom</h2>
  <div id="garcomInitialView">
    <div style="background:#1a1a1a; border-radius:8px; padding:15px; margin-bottom: 20px;">
        <h3>Abrir Nova Mesa</h3>
        <select id="garcomNome"></select>
        <input type="number" id="mesaNumero" placeholder="N√∫mero da Mesa">
        <button class="btn" onclick="abrirMesa(document.getElementById('garcomNome').value, document.getElementById('mesaNumero').value)">Abrir Mesa</button>
    </div>
    <h3>Mesas Abertas</h3>
    <div class="mesas-container" id="mesasAbertasGarcom"></div>
  </div>
  <div id="garcomDetailView" style="display:none;">
    <button class="back-btn" onclick="showInitialGarcomView()">Voltar</button>
    <h3 id="detalhesMesaTitle"></h3>
    <div style="background:#1a1a1a; border-radius:8px; padding:15px; margin-bottom: 20px;">
        <h3>Adicionar Outro Gar√ßom</h3>
        <select id="garcomAdicionarSelect"></select>
        <button class="btn" onclick="adicionarGarcomAMesa()">Adicionar</button>
        <div class="list" id="garconsDaMesa"></div>
    </div>
    <div id="produtosBtns" class="produtos-container"></div>
    <div class="list" id="listaPedidosGarcom"></div>
  </div>
</section>

<!-- üíµ Caixa -->
<section id="caixa">
  <button class="back-btn" onclick="showTab('garcom')">Voltar</button>
  <h2>üíµ Caixa</h2>
  <button class="btn" onclick="toggleCaixaView('mesas')">Mesas Abertas</button>
  <button class="btn" onclick="toggleCaixaView('relatorio')">Relat√≥rio de Vendas</button>
  <div id="mesasAbertas" class="mesas-container"></div>
  <div id="relatorioCaixa" style="display:none;">
    <h3>Relat√≥rio de Mesas Encerradas</h3>
    <div class="list" id="listaVendas"></div>
  </div>
</section>

<!-- ‚öôÔ∏è Admin -->
<section id="admin">
  <button class="back-btn" onclick="showTab('garcom')">Voltar</button>
  <h2>‚öôÔ∏è Administra√ß√£o</h2>
  <h3>üì¶ Estoque</h3>
  <input type="text" id="estNome" placeholder="Nome do Produto">
  <input type="text" id="estIcone" placeholder="√çcone/Emoji (üçï, üç∫)">
  <input type="number" id="estValorVenda" placeholder="Valor de Venda (R$)">
  <input type="number" id="estValorCompra" placeholder="Valor de Compra (R$)">
  <input type="number" id="estQtd" placeholder="Quantidade">
  <button class="btn" id="btnAddEstoque" onclick="addEstoque()">‚ûï Adicionar Produto</button>
  <div class="list" id="listaEstoque"></div>

  <h3>üßë Gerenciar Gar√ßons</h3>
  <input type="text" id="novoGarcom" placeholder="Nome do Gar√ßom">
  <button class="btn" onclick="addGarcom()">‚ûï Adicionar Gar√ßom</button>
  <div class="list" id="listaGarcons"></div>
</section>

<!-- üìä Dashboard -->
<section id="dashboard">
  <button class="back-btn" onclick="showTab('garcom')">Voltar</button>
  <h2>üìä Dashboard</h2>
  <div class="kpi">Receita Total: R$ <span id="kpiReceita">0</span></div>
  <div class="kpi">Lucro Estimado: R$ <span id="kpiLucro">0</span></div>
  <div class="kpi">Ticket M√©dio: R$ <span id="kpiTicket">0</span></div>
  <div class="kpi">Produtos em Estoque: <span id="kpiEstoque">0</span></div>
  <div class="chart-card"><div id="chartVendas" class="chart"></div></div>
  <div class="chart-card"><div id="chartGarcons" class="chart"></div></div>
  <div class="chart-card"><div id="chartPagamentos" class="chart"></div></div>
  <div class="chart-card"><div id="chartLinha" class="chart"></div></div>
  <div class="chart-card"><div id="chartEstoque" class="chart"></div></div>
</section>

<script>
let dados = JSON.parse(localStorage.getItem("restaurante")) || {
  garcons:["Jo√£o","Maria"], 
  mesas:[], 
  estoque:[{nome:"Pizza",icone:"üçï",valor:40,compra:25,qtd:10},
           {nome:"Cerveja",icone:"üç∫",valor:8,compra:3,qtd:30},
           {nome:"Refrigerante",icone:"ü•§",valor:6,compra:2,qtd:20}],
  vendas:[], 
  financeiro:{entradas:0,saidas:0,saldo:0,lucro:0}
};
function save(){ localStorage.setItem("restaurante",JSON.stringify(dados)); }
function beep(){ new Audio("https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg").play(); }

function showModal(message, isConfirm = false, onConfirm = null) {
    const modal = document.getElementById('customModal');
    const modalMessage = document.getElementById('modalMessage');
    const modalButtons = document.getElementById('modalButtons');
    const modalContent = document.getElementById('modalContent');
    modalMessage.textContent = message;
    modalButtons.innerHTML = '';
    modalContent.innerHTML = '';
    if (isConfirm) {
        const okBtn = document.createElement('button');
        okBtn.textContent = 'Sim';
        okBtn.className = 'modal-ok';
        okBtn.onclick = () => { onConfirm(); modal.style.display = 'none'; };
        const cancelBtn = document.createElement('button');
        cancelBtn.textContent = 'N√£o';
        cancelBtn.className = 'modal-cancel';
        cancelBtn.onclick = () => { modal.style.display = 'none'; };
        modalButtons.appendChild(okBtn);
        modalButtons.appendChild(cancelBtn);
    } else {
        const okBtn = document.createElement('button');
        okBtn.textContent = 'OK';
        okBtn.className = 'modal-ok';
        okBtn.onclick = () => { modal.style.display = 'none'; };
        modalButtons.appendChild(okBtn);
    }
    modal.style.display = 'flex';
}

function showEditQuantityModal(mesaIndex, pedidoIndex) {
    const modal = document.getElementById('customModal');
    const modalMessage = document.getElementById('modalMessage');
    const modalButtons = document.getElementById('modalButtons');
    const modalContent = document.getElementById('modalContent');
    const pedido = dados.mesas[mesaIndex].pedidos[pedidoIndex];
    modalMessage.textContent = `Editar quantidade para ${pedido.produto}:`;
    modalButtons.innerHTML = '';
    modalContent.innerHTML = '';
    const input = document.createElement('input');
    input.type = 'number';
    input.value = pedido.qtd;
    input.min = '1';
    modalContent.appendChild(input);
    const okBtn = document.createElement('button');
    okBtn.textContent = 'Salvar';
        okBtn.className = 'modal-ok';
        okBtn.onclick = () => { 
        const newQtd = parseInt(input.value);
        if (newQtd > 0) {
            pedido.qtd = newQtd;
            save();
            renderPedidosGarcom(mesaIndex);
            modal.style.display = 'none';
        } else {
            showModal("A quantidade deve ser maior que zero.");
        }
    };
    const cancelBtn = document.createElement('button');
    cancelBtn.textContent = 'Cancelar';
    cancelBtn.className = 'modal-cancel';
    cancelBtn.onclick = () => { modal.style.display = 'none'; };
    modalButtons.appendChild(okBtn);
    modalButtons.appendChild(cancelBtn);
    modal.style.display = 'flex';
}

function showTab(tab){
  document.querySelectorAll("section").forEach(s=>s.style.display="none");
  document.getElementById(tab).style.display="block";
  if(tab==="garcom"){ showInitialGarcomView(); }
  if(tab==="caixa") renderCaixa();
  if(tab==="admin"){renderEstoque();renderGarcons();}
  if(tab==="dashboard") renderDashboard();
}

let currentMesaIndex = -1;

function showInitialGarcomView() {
    document.getElementById('garcomInitialView').style.display = 'block';
    document.getElementById('garcomDetailView').style.display = 'none';
    renderGarcomSelect();
    renderMesasAbertasGarcom();
}

function openMesaDetailsGarcom(mesaIndex) {
    currentMesaIndex = mesaIndex;
    document.getElementById('garcomInitialView').style.display = 'none';
    document.getElementById('garcomDetailView').style.display = 'block';
    document.getElementById('detalhesMesaTitle').textContent = `Mesa ${dados.mesas[mesaIndex].numero}`;
    renderGarconsDaMesa();
    renderProdutosBtns();
    renderPedidosGarcom(mesaIndex);
}

function abrirMesa(garcom,mesa){
  if(!garcom || !mesa){
    showModal("Preencha gar√ßom e mesa!");
    return;
  }
  if(dados.mesas.find(m=>m.numero==mesa&&m.aberta)){
    showModal("Mesa j√° aberta!");
    return;
  }
  dados.mesas.push({numero:mesa,garcons:[garcom],pedidos:[],aberta:true});
  save();
  showInitialGarcomView(); // Atualiza a visualiza√ß√£o para mostrar a nova mesa
  beep();
}

function adicionarGarcomAMesa() {
    const garcom = document.getElementById('garcomAdicionarSelect').value;
    const mesa = dados.mesas[currentMesaIndex];
    if (garcom && mesa) {
        if (!mesa.garcons.includes(garcom)) {
            mesa.garcons.push(garcom);
            save();
            renderGarconsDaMesa();
            showModal(`Gar√ßom ${garcom} adicionado √† mesa ${mesa.numero}.`);
        } else {
            showModal(`Gar√ßom ${garcom} j√° est√° na mesa.`);
        }
    }
}

function addPedido(idx){
  if (currentMesaIndex === -1) {
    showModal("Selecione uma mesa para adicionar o pedido.");
    return;
  }
  let mesaObj = dados.mesas[currentMesaIndex];
  let produto = dados.estoque.find((p,i) => i === idx);
  if(!produto || produto.qtd<=0){showModal("Estoque insuficiente!");return;}
  let pedidoExistente = mesaObj.pedidos.find(p => p.produto === produto.nome);
  if (pedidoExistente) {
      pedidoExistente.qtd++;
  } else {
      mesaObj.pedidos.push({produto:produto.nome,valor:produto.valor,compra:produto.compra,qtd:1});
  }
  produto.qtd--;
  save();
  renderPedidosGarcom(currentMesaIndex);
  beep();
}

function removerPedido(mesaIndex, pedidoIndex) {
    showModal("Tem certeza que deseja remover este item?", true, () => {
        let mesa = dados.mesas[mesaIndex];
        let pedido = mesa.pedidos[pedidoIndex];
        let produtoEstoque = dados.estoque.find(p => p.nome === pedido.produto);
        if (produtoEstoque) {
            produtoEstoque.qtd += pedido.qtd;
        }
        mesa.pedidos.splice(pedidoIndex, 1);
        save();
        renderPedidosGarcom(mesaIndex);
        showModal("üóëÔ∏è Item removido!");
    });
}

function renderMesasAbertasGarcom() {
    const mesasContainer = document.getElementById('mesasAbertasGarcom');
    const welcomeCard = document.getElementById('welcomeCard');
    const mesasAtivas = dados.mesas.filter(m => m.aberta);
    
    if (mesasAtivas.length === 0) {
        mesasContainer.innerHTML = "";
        welcomeCard.style.display = 'block';
    } else {
        welcomeCard.style.display = 'none';
        mesasContainer.innerHTML = "";
        mesasAtivas.forEach((m, i) => {
            const card = document.createElement('div');
            card.className = 'mesa-card';
            card.innerHTML = `
                <h4>Mesa ${m.numero}</h4>
                <p>Gar√ßons: ${m.garcons.join(", ")}</p>
            `;
            card.onclick = () => openMesaDetailsGarcom(i);
            mesasContainer.appendChild(card);
        });
    }
}

function renderPedidosGarcom(mesaIndex){
    const listaPedidos = document.getElementById('listaPedidosGarcom');
    listaPedidos.innerHTML = '';
    const mesa = dados.mesas[mesaIndex];
    let pedidosHtml = mesa.pedidos.map((p, pedidoIndex) => `
      <div class="list-item">
        <span>${p.qtd}x ${p.produto} - R$${(p.valor * p.qtd).toFixed(2)}</span>
        <div class="list-item-buttons">
          <button class="edit-btn" onclick="showEditQuantityModal(${mesaIndex}, ${pedidoIndex})">Editar</button>
          <button class="remove-btn" onclick="removerPedido(${mesaIndex}, ${pedidoIndex})">Remover</button>
        </div>
      </div>
    `).join("");
    listaPedidos.innerHTML = pedidosHtml || "<p>Nenhum pedido.</p>";
}

function renderGarcomSelect(){
  let sel=document.getElementById("garcomNome");
  let selDetalhe=document.getElementById("garcomAdicionarSelect");
  
  if (sel) {
      sel.innerHTML="";
  }
  if (selDetalhe) {
      selDetalhe.innerHTML="";
  }
  
  if (dados.garcons.length === 0) {
      if (sel) sel.innerHTML = `<option value="">Nenhum gar√ßom</option>`;
      if (selDetalhe) selDetalhe.innerHTML = `<option value="">Nenhum gar√ßom</option>`;
  } else {
    dados.garcons.forEach(g=>{
      if (sel) {
        let opt=document.createElement("option"); opt.value=g; opt.textContent=g; sel.appendChild(opt);
      }
      if (selDetalhe) {
        let optDetalhe=document.createElement("option"); optDetalhe.value=g; optDetalhe.textContent=g; selDetalhe.appendChild(optDetalhe);
      }
    });
  }
}
function renderGarconsDaMesa() {
    const garconsDaMesaDiv = document.getElementById('garconsDaMesa');
    const mesa = dados.mesas[currentMesaIndex];
    if (mesa) {
        garconsDaMesaDiv.innerHTML = `Gar√ßons: ${mesa.garcons.join(", ")}`;
    } else {
        garconsDaMesaDiv.innerHTML = '';
    }
}
function renderProdutosBtns(){
  let div=document.getElementById("produtosBtns"); div.innerHTML="";
  dados.estoque.forEach((p,i)=>{
    div.innerHTML+=`
    <button class="prod-btn" onclick="addPedido(${i})">
      <div class="icon">${p.icone||"üçΩÔ∏è"}</div>
      <div class="details">
        <div>${p.nome}</div>
        <div>R$${p.valor.toFixed(2)}</div>
      </div>
    </button>`;
  });
}

function renderCaixa() {
    toggleCaixaView('mesas');
}

function toggleCaixaView(view) {
    const mesasView = document.getElementById('mesasAbertas');
    const relatorioView = document.getElementById('relatorioCaixa');
    
    if (mesasView && relatorioView) {
        if (view === 'mesas') {
            mesasView.style.display = 'flex';
            relatorioView.style.display = 'none';
            renderMesasAbertas();
        } else {
            mesasView.style.display = 'none';
            relatorioView.style.display = 'block';
            renderRelatorioVendas();
        }
    }
}

function renderMesasAbertas(){
    const mesasAbertasDiv = document.getElementById("mesasAbertas");
    if (!mesasAbertasDiv) return; // Adicionado verifica√ß√£o de nulidade
    mesasAbertasDiv.innerHTML = "";
    const mesasAtivas = dados.mesas.filter(m => m.aberta);
    if (mesasAtivas.length === 0) {
        mesasAbertasDiv.innerHTML = "<p style='width: 100%; text-align: center;'>Nenhuma mesa aberta.</p>";
    } else {
        mesasAtivas.forEach((m, i) => {
            const card = document.createElement('div');
            card.className = 'mesa-card';
            card.innerHTML = `
                <h4>Mesa ${m.numero}</h4>
                <p>Gar√ßons: ${m.garcons.join(", ")}</p>
            `;
            card.onclick = () => openMesaDetails(i);
            mesasAbertasDiv.appendChild(card);
        });
    }
}

function renderRelatorioVendas() {
    const listaVendas = document.getElementById('listaVendas');
    if (!listaVendas) return; // Adicionado verifica√ß√£o de nulidade
    listaVendas.innerHTML = "";
    if (dados.vendas.length === 0) {
        listaVendas.innerHTML = "<p>Nenhuma venda registrada.</p>";
        return;
    }
    dados.vendas.forEach(v => {
        const item = document.createElement('div');
        item.className = 'list-item';
        item.innerHTML = `
            <span>Mesa ${v.mesa} - Gar√ßons: ${v.garcons.join(", ")}</span>
            <span>R$${v.total.toFixed(2)} (${v.pagamento})</span>
        `;
        listaVendas.appendChild(item);
    });
}

function openMesaDetails(mesaIndex) {
    const mesa = dados.mesas.find((m, i) => i === mesaIndex);
    if (!mesa) return;

    const modal = document.getElementById('mesaDetailsModal');
    document.getElementById('mesaDetailsTitle').textContent = `Mesa ${mesa.numero}`;
    
    let pedidosHtml = mesa.pedidos.map(p => `
        <div class="list-item">
            <span>${p.qtd}x ${p.produto} - R$${(p.valor * p.qtd).toFixed(2)}</span>
        </div>
    `).join("");
    document.getElementById('mesaDetailsList').innerHTML = pedidosHtml || "Nenhum pedido.";
    
    const subtotal = mesa.pedidos.reduce((s, p) => s + p.valor * p.qtd, 0);
    const taxCheckbox = document.getElementById('taxCheckbox');
    if (taxCheckbox) {
        taxCheckbox.checked = false; 
        taxCheckbox.onchange = () => updateFinalTotal(subtotal);
    }

    updateFinalTotal(subtotal);
    
    const payButtonsContainer = document.getElementById('mesaDetailsPayButtons');
    if (payButtonsContainer) {
      payButtonsContainer.innerHTML = `
          <button class="pay-btn pay-pix" onclick="showPaymentConfirmation(${mesaIndex}, 'Pix')">‚ö° Pix</button>
          <button class="pay-btn pay-debito" onclick="showPaymentConfirmation(${mesaIndex}, 'D√©bito')">üí≥ D√©bito</button>
          <button class="pay-btn pay-credito" onclick="showPaymentConfirmation(${mesaIndex}, 'Cr√©dito')">üí≥ Cr√©dito</button>
          <button class="pay-btn pay-dinheiro" onclick="showPaymentConfirmation(${mesaIndex}, 'Dinheiro')">üíµ Dinheiro</button>
      `;
    }

    if (modal) {
      modal.onclick = (e) => {
          if (e.target.id === 'mesaDetailsModal') {
              modal.style.display = 'none';
          }
      };
      modal.style.display = 'flex';
    }
}

function updateFinalTotal(subtotal) {
    const taxCheckbox = document.getElementById('taxCheckbox');
    const finalTotalSpan = document.getElementById('finalTotal');
    if (!finalTotalSpan) return;

    let finalTotal = subtotal;
    if (taxCheckbox && taxCheckbox.checked) {
        finalTotal *= 1.1;
    }
    finalTotalSpan.textContent = `R$${finalTotal.toFixed(2)}`;
}

function showPaymentConfirmation(mesaIndex, pagamento) {
    const mesa = dados.mesas.find((m, i) => i === mesaIndex);
    if (!mesa) return;

    let subtotal = mesa.pedidos.reduce((s, p) => s + p.valor * p.qtd, 0);
    const taxCheckbox = document.getElementById('taxCheckbox');
    let total = subtotal;
    if (taxCheckbox && taxCheckbox.checked) {
        total *= 1.1;
    }

    const confirmPaymentModal = document.getElementById('confirmPaymentModal');
    if (confirmPaymentModal) {
      document.getElementById('confirmPaymentTitle').textContent = `Confirma√ß√£o de Pagamento`;
      document.getElementById('confirmPaymentInfo').innerHTML = `
          Mesa: ${mesa.numero}<br>
          Total: R$${total.toFixed(2)}<br>
          Forma de Pagamento: ${pagamento}
      `;
      const confirmBtn = document.getElementById('confirmPaymentBtn');
      if (confirmBtn) {
          confirmBtn.onclick = () => encerrarMesa(mesaIndex, pagamento);
      }
      confirmPaymentModal.style.display = 'flex';
    }
}

function encerrarMesa(idx, pagamento){
    const mesa = dados.mesas.find((m, index) => index === idx);
    if (!mesa) return;

    let total = mesa.pedidos.reduce((s, p) => s + p.valor * p.qtd, 0);
    const taxCheckbox = document.getElementById('taxCheckbox');
    if (taxCheckbox && taxCheckbox.checked) {
        total *= 1.1;
    }

    const lucro = mesa.pedidos.reduce((s,p)=>s+((p.valor-p.compra)*p.qtd),0);
    dados.vendas.push({mesa:mesa.numero, garcons:mesa.garcons, total, pagamento, data: new Date().toLocaleDateString(), lucro});
    dados.financeiro.entradas+=total;
    dados.financeiro.lucro+=lucro;
    dados.financeiro.saldo+=total;
    mesa.aberta = false;

    save();
    
    const mesaDetailsModal = document.getElementById('mesaDetailsModal');
    if (mesaDetailsModal) mesaDetailsModal.style.display = 'none';
    
    const confirmPaymentModal = document.getElementById('confirmPaymentModal');
    if (confirmPaymentModal) confirmPaymentModal.style.display = 'none';

    renderCaixa(); // Atualiza a tela do Caixa para remover a mesa fechada
    beep();
    showModal("‚úÖ Mesa encerrada!");
}

function addEstoque(){
  let nome=document.getElementById("estNome").value;
  let icone=document.getElementById("estIcone").value;
  let valor=parseFloat(document.getElementById("estValorVenda").value)||0;
  let compra=parseFloat(document.getElementById("estValorCompra").value)||0;
  let qtd=parseInt(document.getElementById("estQtd").value)||0;
  if(!nome||valor<=0||compra<=0){showModal("Preencha todos os campos!");return;}
  dados.estoque.push({nome,icone,valor,compra,qtd});
  save();renderEstoque();showModal("‚úÖ Produto adicionado!");
  document.getElementById("estNome").value = "";
  document.getElementById("estIcone").value = "";
  document.getElementById("estValorVenda").value = "";
  document.getElementById("estValorCompra").value = "";
  document.getElementById("estQtd").value = "";
}

let editIndex = -1;
function editarEstoque(index){
    const item = dados.estoque[index];
    document.getElementById("estNome").value = item.nome;
    document.getElementById("estIcone").value = item.icone;
    document.getElementById("estValorVenda").value = item.valor;
    document.getElementById("estValorCompra").value = item.compra;
    document.getElementById("estQtd").value = item.qtd;
    document.getElementById("btnAddEstoque").textContent = "üíæ Salvar Edi√ß√£o";
    editIndex = index;
    document.getElementById("btnAddEstoque").onclick = salvarEdicaoEstoque;
}

function salvarEdicaoEstoque(){
    const nome=document.getElementById("estNome").value;
    const icone=document.getElementById("estIcone").value;
    const valor=parseFloat(document.getElementById("estValorVenda").value)||0;
    const compra=parseFloat(document.getElementById("estValorCompra").value)||0;
    const qtd=parseInt(document.getElementById("estQtd").value)||0;
    if(!nome||valor<=0||compra<=0){showModal("Preencha todos os campos!");return;}
    dados.estoque[editIndex] = {nome,icone,valor,compra,qtd};
    save();
    showModal("‚úÖ Produto editado!");
    document.getElementById("estNome").value = "";
    document.getElementById("estIcone").value = "";
    document.getElementById("estValorVenda").value = "";
    document.getElementById("estValorCompra").value = "";
    document.getElementById("estQtd").value = "";
    document.getElementById("btnAddEstoque").textContent = "‚ûï Adicionar Produto";
    document.getElementById("btnAddEstoque").onclick = addEstoque;
    editIndex = -1;
    renderEstoque();
}


function removerEstoque(index){
  showModal("Tem certeza que deseja remover este produto?", true, () => {
    dados.estoque.splice(index,1);
    save();renderEstoque();showModal("üóëÔ∏è Produto removido!");
  });
}
function renderEstoque(){
  let html=""; dados.estoque.forEach((e,i)=>{html+=`<div>${e.icone||"üçΩÔ∏è"} ${e.nome} - Venda: R$${e.valor.toFixed(2)} | Compra: R$${e.compra.toFixed(2)} | Qtd:${e.qtd} ${e.qtd<5?'<span class="low-stock">(baixo estoque)</span>':''}
  <button class="edit-btn" onclick="editarEstoque(${i})">Editar</button>
  <button class="remove-btn" onclick="removerEstoque(${i})">Remover</button>
  </div>`;});
  document.getElementById("listaEstoque").innerHTML=html||"<p>Sem produtos.</p>";
  renderProdutosBtns();
}
function addGarcom(){
  let nome=document.getElementById("novoGarcom").value;
  if(!nome){showModal("Digite o nome do gar√ßom!");return;}
  if(dados.garcons.includes(nome)) {showModal("Gar√ßom j√° cadastrado!"); return;}
  dados.garcons.push(nome);
  save();renderGarcons();renderGarcomSelect();showModal("‚úÖ Gar√ßom adicionado!");
  document.getElementById("novoGarcom").value = "";
}
function removerGarcom(index) {
    showModal("Tem certeza que deseja remover este gar√ßom?", true, () => {
        dados.garcons.splice(index, 1);
        save();
        renderGarcons();
        renderGarcomSelect();
        showModal("üóëÔ∏è Gar√ßom removido!");
    });
}
function renderGarcons(){
  let html=""; dados.garcons.forEach((g, i)=>{html+=`<div>${g} <button class="remove-btn" onclick="removerGarcom(${i})">Remover</button></div>`;});
  document.getElementById("listaGarcons").innerHTML=html||"<p>Nenhum gar√ßom.</p>";
}

function renderDashboard(){
  document.getElementById("kpiReceita").innerText=dados.financeiro.entradas.toFixed(2);
  document.getElementById("kpiLucro").innerText=dados.financeiro.lucro.toFixed(2);
  document.getElementById("kpiTicket").innerText=(dados.financeiro.entradas/(dados.vendas.length||1)).toFixed(2);
  document.getElementById("kpiEstoque").innerText=dados.estoque.reduce((s,p)=>s+p.qtd,0);
  let porProd={}; dados.vendas.forEach(v=>{porProd[v.mesa]=(porProd[v.mesa]||0)+v.total;});
  echarts.init(document.getElementById("chartVendas")).setOption({
    title:{text:"Vendas por Mesa",textStyle:{color:"#d4af37"}},
    xAxis:{type:"category",data:Object.keys(porProd),axisLabel:{color:"#fff"}},
    yAxis:{type:"value",axisLabel:{color:"#fff"}},
    series:[{type:"bar",data:Object.values(porProd),label:{show:true,color:"#fff"}}]
  });
  let porGarcom={}; dados.vendas.forEach(v=>{v.garcons.forEach(g => {porGarcom[g]=(porGarcom[g]||0)+v.total;});});
  echarts.init(document.getElementById("chartGarcons")).setOption({
    title:{text:"Vendas por Gar√ßom",textStyle:{color:"#d4af37"}},
    xAxis:{type:"category",data:Object.keys(porGarcom),axisLabel:{color:"#fff"}},
    yAxis:{type:"value",axisLabel:{color:"#fff"}},
    series:[{type:"bar",data:Object.values(porGarcom),label:{show:true,color:"#fff"}}]
  });
  let formas={}; dados.vendas.forEach(v=>{formas[v.pagamento]=(formas[v.pagamento]||0)+v.total;});
  echarts.init(document.getElementById("chartPagamentos")).setOption({
    title:{text:"Formas de Pagamento",textStyle:{color:"#d4af37"}},
    series:[{type:"pie",radius:["40%","70%"],data:Object.entries(formas).map(([k,v])=>({name:k,value:v})),label:{show:true,color:"#fff"}}]
  });
  let porData={}; dados.vendas.forEach(v=>{porData[v.data]=(porData[v.data]||0)+v.total;});
  echarts.init(document.getElementById("chartLinha")).setOption({
    title:{text:"Receita no Tempo",textStyle:{color:"#d4af37"}},
    xAxis:{type:"category",data:Object.keys(porData).sort(),axisLabel:{color:"#fff"}},
    yAxis:{type:"value",axisLabel:{color:"#fff"}},
    series:[{type:"line",data:Object.values(porData),smooth:true,areaStyle:{color:"rgba(212,175,55,0.3)"},label:{show:true,color:"#fff"}}]
  });
  echarts.init(document.getElementById("chartEstoque")).setOption({
    title:{text:"Estoque Atual",textStyle:{color:"#d4af37"}},
    xAxis:{type:"category",data:dados.estoque.map(p=>p.nome),axisLabel:{color:"#fff"}},
    yAxis:{type:"value",axisLabel:{color:"#fff"}},
    series:[{type:"bar",data:dados.estoque.map(p=>p.qtd),label:{show:true,color:"#fff"}}]
  });
}

document.addEventListener('DOMContentLoaded', () => {
    showTab('inicio');
});
</script>
</body>
</html>
